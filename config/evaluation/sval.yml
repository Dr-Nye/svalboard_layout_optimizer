metrics:
  finger_balance:
    enabled: true
    weight: 25.0
    normalization:
      type: fixed
      value: 1.0
    params:
      # Thumb values are ignored.
      intended_loads:
        [Left, Pinky]: 1.1
        [Left, Ring]: 1.3
        [Left, Middle]: 1.9
        [Left, Index]: 2
        [Left, Thumb]: 2
        [Right, Thumb]: 2
        [Right, Index]: 2
        [Right, Middle]: 1.9
        [Right, Ring]: 1.3
        [Right, Pinky]: 1.1
      finger_factors:
        Pinky: 2.0
        Ring: 1.25
        Middle: 1.0
        Index: 0.75
        Thumb: 1.0

  hand_disbalance:
    enabled: true
    weight: 50.0
    normalization:
      type: fixed
      value: 1.0
    params:
      null: null

  # Each keystroke incurs a cost (defined in the keyboard's layout config)
  key_costs:
    enabled: true
    weight: 5.0
    normalization:
      type: weight_found
      value: 1.0
    params:
      null: null

  modifier_usage:
    enabled: false
    weight: 100.0
    normalization:
      type: weight_found
      value: 1.0
    params:
      hold_cost: 1.0
      one_shot_cost: 0.0
      long_press_cost: 1.0

  # Penalize double letters on difficult positions
  position_penalties:
    enabled: true
    weight: 200.0
    normalization:
      type: weight_found
      value: 1.0
    params:
      penalty_positions:
        # CATEGORY 1: High-frequency double letters (l,e,s,o,t,r,h,n)
        # Only allowed on center and south positions of all fingers (ring, middle, index, pinky)

        # CATEGORY 2: moderate-frequency double letters (f,p)
        # Only allowed on center, south, and north positions of all fingers

        # CATEGORY 3: Lower-frequency double letters (c,d,g,m)
        # Only allowed on center, south, north, and favorable lateral positions of all fingers
        # m is also allowed on favorable laterals
        # Favorable lateral: left hand = east (toward center), right hand = west (toward center)

        # === CATEGORY 1 LETTERS ===
        l:
          # Left pinky
          [3, 2]: 1.0 # west
          [1, 2]: 1.0 # east
          [2, 1]: 1.0 # north
          # Left ring
          [6, 2]: 1.0 # west
          [4, 2]: 1.0 # east
          [5, 1]: 1.0 # north
          # Left middle
          [9, 2]: 1.0 # west
          [7, 2]: 1.0 # east
          [8, 1]: 1.0 # north
          # Left index
          [10, 2]: 1.0 # east
          [11, 1]: 1.0 # north
          # Right index
          [13, 2]: 1.0 # west
          [14, 1]: 1.0 # north
          # Right middle
          [16, 2]: 1.0 # west
          [18, 2]: 1.0 # east
          [17, 1]: 1.0 # north
          # Right ring
          [19, 2]: 1.0 # west
          [21, 2]: 1.0 # east
          [20, 1]: 1.0 # north
          # Right pinky
          [22, 2]: 1.0 # west
          [24, 2]: 1.0 # east
          [23, 1]: 1.0 # north
        e:
          # Left pinky
          [3, 2]: 1.0 # west
          [1, 2]: 1.0 # east
          [2, 1]: 1.0 # north
          # Left ring
          [6, 2]: 1.0 # west
          [4, 2]: 1.0 # east
          [5, 1]: 1.0 # north
          # Left middle
          [9, 2]: 1.0 # west
          [7, 2]: 1.0 # east
          [8, 1]: 1.0 # north
          # Left index
          [10, 2]: 1.0 # east
          [11, 1]: 1.0 # north
          # Right index
          [13, 2]: 1.0 # west
          [14, 1]: 1.0 # north
          # Right middle
          [16, 2]: 1.0 # west
          [18, 2]: 1.0 # east
          [17, 1]: 1.0 # north
          # Right ring
          [19, 2]: 1.0 # west
          [21, 2]: 1.0 # east
          [20, 1]: 1.0 # north
          # Right pinky
          [22, 2]: 1.0 # west
          [24, 2]: 1.0 # east
          [23, 1]: 1.0 # north
        s:
          # Left pinky
          [3, 2]: 1.0 # west
          [1, 2]: 1.0 # east
          [2, 1]: 1.0 # north
          # Left ring
          [6, 2]: 1.0 # west
          [4, 2]: 1.0 # east
          [5, 1]: 1.0 # north
          # Left middle
          [9, 2]: 1.0 # west
          [7, 2]: 1.0 # east
          [8, 1]: 1.0 # north
          # Left index
          [10, 2]: 1.0 # east
          [11, 1]: 1.0 # north
          # Right index
          [13, 2]: 1.0 # west
          [14, 1]: 1.0 # north
          # Right middle
          [16, 2]: 1.0 # west
          [18, 2]: 1.0 # east
          [17, 1]: 1.0 # north
          # Right ring
          [19, 2]: 1.0 # west
          [21, 2]: 1.0 # east
          [20, 1]: 1.0 # north
          # Right pinky
          [22, 2]: 1.0 # west
          [24, 2]: 1.0 # east
          [23, 1]: 1.0 # north
        o:
          # Left pinky
          [3, 2]: 1.0 # west
          [1, 2]: 1.0 # east
          [2, 1]: 1.0 # north
          # Left ring
          [6, 2]: 1.0 # west
          [4, 2]: 1.0 # east
          [5, 1]: 1.0 # north
          # Left middle
          [9, 2]: 1.0 # west
          [7, 2]: 1.0 # east
          [8, 1]: 1.0 # north
          # Left index
          [10, 2]: 1.0 # east
          [11, 1]: 1.0 # north
          # Right index
          [13, 2]: 1.0 # west
          [14, 1]: 1.0 # north
          # Right middle
          [16, 2]: 1.0 # west
          [18, 2]: 1.0 # east
          [17, 1]: 1.0 # north
          # Right ring
          [19, 2]: 1.0 # west
          [21, 2]: 1.0 # east
          [20, 1]: 1.0 # north
          # Right pinky
          [22, 2]: 1.0 # west
          [24, 2]: 1.0 # east
          [23, 1]: 1.0 # north
        t:
          # Left pinky
          [3, 2]: 1.0 # west
          [1, 2]: 1.0 # east
          [2, 1]: 1.0 # north
          # Left ring
          [6, 2]: 1.0 # west
          [4, 2]: 1.0 # east
          [5, 1]: 1.0 # north
          # Left middle
          [9, 2]: 1.0 # west
          [7, 2]: 1.0 # east
          [8, 1]: 1.0 # north
          # Left index
          [10, 2]: 1.0 # east
          [11, 1]: 1.0 # north
          # Right index
          [13, 2]: 1.0 # west
          [14, 1]: 1.0 # north
          # Right middle
          [16, 2]: 1.0 # west
          [18, 2]: 1.0 # east
          [17, 1]: 1.0 # north
          # Right ring
          [19, 2]: 1.0 # west
          [21, 2]: 1.0 # east
          [20, 1]: 1.0 # north
          # Right pinky
          # [23, 2]: 1.0 # center
          # [23, 3]: 1.0 # south
          [22, 2]: 1.0 # west
          [24, 2]: 1.0 # east
          [23, 1]: 1.0 # north
        h:
          # Left pinky
          [3, 2]: 1.0 # west
          [1, 2]: 1.0 # east
          [2, 1]: 1.0 # north
          # Left ring
          [6, 2]: 1.0 # west
          [4, 2]: 1.0 # east
          [5, 1]: 1.0 # north
          # Left middle
          [9, 2]: 1.0 # west
          [7, 2]: 1.0 # east
          [8, 1]: 1.0 # north
          # Left index
          [10, 2]: 1.0 # east
          [11, 1]: 1.0 # north
          # Right index
          [13, 2]: 1.0 # west
          [14, 1]: 1.0 # north
          # Right middle
          [16, 2]: 1.0 # west
          [18, 2]: 1.0 # east
          [17, 1]: 1.0 # north
          # Right ring
          [19, 2]: 1.0 # west
          [21, 2]: 1.0 # east
          [20, 1]: 1.0 # north
          # Right pinky
          # [23, 2]: 1.0 # center
          # [23, 3]: 1.0 # south
          [22, 2]: 1.0 # west
          [24, 2]: 1.0 # east
          [23, 1]: 1.0 # north

        # === CATEGORY 2 LETTERS ===
        f:
          # Left pinky
          [3, 2]: 1.0 # west
          [1, 2]: 1.0 # east
          [2, 1]: 1.0 # north
          # Left ring
          [6, 2]: 1.0 # west
          [4, 2]: 1.0 # east
          [5, 1]: 1.0 # north
          # Left middle
          [9, 2]: 1.0 # west
          [7, 2]: 1.0 # east
          [8, 1]: 1.0 # north
          # Left index
          [10, 2]: 1.0 # east
          [11, 1]: 1.0 # north
          # Right index
          [13, 2]: 1.0 # west
          [14, 1]: 1.0 # north
          # Right middle
          [16, 2]: 1.0 # west
          [18, 2]: 1.0 # east
          [17, 1]: 1.0 # north
          # Right ring
          [19, 2]: 1.0 # west
          [21, 2]: 1.0 # east
          [20, 1]: 1.0 # north
          # Right pinky
          [22, 2]: 1.0 # west
          [24, 2]: 1.0 # east
          [23, 1]: 1.0 # north
        p:
          # Left pinky
          [3, 2]: 1.0 # west
          [1, 2]: 1.0 # east
          [2, 1]: 1.0 # north
          # Left ring
          [6, 2]: 1.0 # west
          [4, 2]: 1.0 # east
          [5, 1]: 1.0 # north
          # Left middle
          [9, 2]: 1.0 # west
          [7, 2]: 1.0 # east
          [8, 1]: 1.0 # north
          # Left index
          [10, 2]: 1.0 # east
          [11, 1]: 1.0 # north
          # Right index
          [13, 2]: 1.0 # west
          [14, 1]: 1.0 # north
          # Right middle
          [16, 2]: 1.0 # west
          [18, 2]: 1.0 # east
          [17, 1]: 1.0 # north
          # Right ring
          [19, 2]: 1.0 # west
          [21, 2]: 1.0 # east
          [20, 1]: 1.0 # north
          # Right pinky
          [22, 2]: 1.0 # west
          [24, 2]: 1.0 # east
          [23, 1]: 1.0 # north

        # === CATEGORY 3 LETTERS ===
        c:
          # Left pinky
          [3, 2]: 1.0 # west
          [1, 2]: 1.0 # east
          [2, 1]: 1.0 # north
          # Left ring
          [6, 2]: 1.0 # west
          [4, 2]: 1.0 # east
          [5, 1]: 1.0 # north
          # Left middle
          [9, 2]: 1.0 # west
          [7, 2]: 1.0 # east
          [8, 1]: 1.0 # north
          # Left index
          [10, 2]: 1.0 # east
          [11, 1]: 1.0 # north
          # Right index
          [13, 2]: 1.0 # west
          [14, 1]: 1.0 # north
          # Right middle
          [16, 2]: 1.0 # west
          [18, 2]: 1.0 # east
          [17, 1]: 1.0 # north
          # Right ring
          [19, 2]: 1.0 # west
          [21, 2]: 1.0 # east
          [20, 1]: 1.0 # north
          # Right pinky
          [22, 2]: 1.0 # west
          [24, 2]: 1.0 # east
          [23, 1]: 1.0 # north
        d:
          # Left pinky
          [3, 2]: 1.0 # west
          [1, 2]: 1.0 # east
          [2, 1]: 1.0 # north
          # Left ring
          [6, 2]: 1.0 # west
          [4, 2]: 1.0 # east
          [5, 1]: 1.0 # north
          # Left middle
          [9, 2]: 1.0 # west
          [7, 2]: 1.0 # east
          [8, 1]: 1.0 # north
          # Left index
          [10, 2]: 1.0 # east
          [11, 1]: 1.0 # north
          # Right index
          [13, 2]: 1.0 # west
          [14, 1]: 1.0 # north
          # Right middle
          [16, 2]: 1.0 # west
          [18, 2]: 1.0 # east
          [17, 1]: 1.0 # north
          # Right ring
          [19, 2]: 1.0 # west
          [21, 2]: 1.0 # east
          [20, 1]: 1.0 # north
          # Right pinky
          [22, 2]: 1.0 # west
          [24, 2]: 1.0 # east
          [23, 1]: 1.0 # north
        g:
          # Left pinky
          [3, 2]: 1.0 # west
          [1, 2]: 1.0 # east
          [2, 1]: 1.0 # north
          # Left ring
          [6, 2]: 1.0 # west
          [4, 2]: 1.0 # east
          [5, 1]: 1.0 # north
          # Left middle
          [9, 2]: 1.0 # west
          [7, 2]: 1.0 # east
          [8, 1]: 1.0 # north
          # Left index
          [10, 2]: 1.0 # east
          [11, 1]: 1.0 # north
          # Right index
          [13, 2]: 1.0 # west
          [14, 1]: 1.0 # north
          # Right middle
          [16, 2]: 1.0 # west
          [18, 2]: 1.0 # east
          [17, 1]: 1.0 # north
          # Right ring
          [19, 2]: 1.0 # west
          [21, 2]: 1.0 # east
          [20, 1]: 1.0 # north
          # Right pinky
          [22, 2]: 1.0 # west
          [24, 2]: 1.0 # east
          [23, 1]: 1.0 # north
        m:
          # Left pinky
          [3, 2]: 1.0 # west
          [1, 2]: 1.0 # east
          [2, 1]: 1.0 # north
          # Left ring
          [6, 2]: 1.0 # west
          [4, 2]: 1.0 # east
          [5, 1]: 1.0 # north
          # Left middle
          [9, 2]: 1.0 # west
          [7, 2]: 1.0 # east
          [8, 1]: 1.0 # north
          # Left index
          [10, 2]: 1.0 # east
          [11, 1]: 1.0 # north
          # Right index
          [13, 2]: 1.0 # west
          [14, 1]: 1.0 # north
          # Right middle
          [16, 2]: 1.0 # west
          [18, 2]: 1.0 # east
          [17, 1]: 1.0 # north
          # Right ring
          [19, 2]: 1.0 # west
          [21, 2]: 1.0 # east
          [20, 1]: 1.0 # north
          # Right pinky
          [22, 2]: 1.0 # west
          [24, 2]: 1.0 # east
          [23, 1]: 1.0 # north

        # === PUNCTUATION MARKS ===
        # Forbid comma, period, apostrophe, and hyphen on center keys
        ",":
          # Left pinky center
          [2, 2]: 1.0
          # Left ring center
          [5, 2]: 1.0
          # Left middle center
          [8, 2]: 1.0
          # Left index center
          [11, 2]: 1.0
          # Right index center
          [14, 2]: 1.0
          # Right middle center
          [17, 2]: 1.0
          # Right ring center
          [20, 2]: 1.0
          # Right pinky center
          [23, 2]: 1.0
        ".":
          # Left pinky center
          [2, 2]: 1.0
          # Left ring center
          [5, 2]: 1.0
          # Left middle center
          [8, 2]: 1.0
          # Left index center
          [11, 2]: 1.0
          # Right index center
          [14, 2]: 1.0
          # Right middle center
          [17, 2]: 1.0
          # Right ring center
          [20, 2]: 1.0
          # Right pinky center
          [23, 2]: 1.0
        "'":
          # Left pinky center
          [2, 2]: 1.0
          # Left ring center
          [5, 2]: 1.0
          # Left middle center
          [8, 2]: 1.0
          # Left index center
          [11, 2]: 1.0
          # Right index center
          [14, 2]: 1.0
          # Right middle center
          [17, 2]: 1.0
          # Right ring center
          [20, 2]: 1.0
          # Right pinky center
          [23, 2]: 1.0
        "-":
          # Left pinky center
          [2, 2]: 1.0
          # Left ring center
          [5, 2]: 1.0
          # Left middle center
          [8, 2]: 1.0
          # Left index center
          [11, 2]: 1.0
          # Right index center
          [14, 2]: 1.0
          # Right middle center
          [17, 2]: 1.0
          # Right ring center
          [20, 2]: 1.0
          # Right pinky center
          [23, 2]: 1.0

  # =============================================================================
  # Bigram metrics
  # =============================================================================

  sfb:
    enabled: true
    weight: 100.0
    normalization:
      type: weight_found
      value: 1.0

    params:
      default_cost: 0
      ignore_thumb: true
      exclude_modifiers: false

      # Format:
      #   from:
      #     to: cost
      #     to: cost
      #     etc.
      costs:
        Center:
          North: 3.0
          South: 0.0
          In: 1.0
          Out: 2.0
        North:
          Center: 2.0
          South: 5.0
          In: 3.0
          Out: 4.0
        South:
          Center: 1.0
          North: 6.0
          In: 2.0
          Out: 3.0
        In:
          Center: 2.0
          North: 4.0
          South: 2.0
          Out: 5.0
        Out:
          Center: 3.0
          North: 5.0
          South: 3.0
          In: 5.0
        Pad:
          Up: 0.5
        Up:
          Pad: 3.0

      finger_factors:
        Pinky: 2.0
        Ring: 1.5
        Middle: 1.0
        Index: 0.75
        Thumb: 1.0

      # High-frequency roll penalty
      critical_bigram_fraction: 0.0003
      critical_bigram_factor: 50.0

  bigram_stats:
    enabled: true
    weight: 0.0
    normalization:
      type: fixed
      value: 1.0
    params:
      ignore_thumb: true
      ignore_modifiers: true

  scissors:
    enabled: true
    weight: 100.0
    normalization:
      type: weight_found
      value: 1.0
    params:
      # Factor for Full Scissor Vertical (North-South opposition)
      full_scissor_vertical_factor: 5.0
      # Factor for Full Scissor Squeeze (fingers moving inward)
      full_scissor_squeeze_factor: 5.0
      # Factor for Full Scissor Splay (fingers moving outward)
      full_scissor_splay_factor: 5.0
      # Factor for Half Scissor (diagonal lateral+vertical)
      half_scissor_factor: 1.5
      # Factor for Lateral (lateral+center)
      lateral_factor: 1.0
      # High-frequency scissor penalty
      critical_bigram_fraction: 0.0003
      critical_bigram_factor: 50.0

  manual_bigram_penalty:
    enabled: true
    weight: 1000.0
    normalization:
      type: weight_found
      value: 1.0
    params:
      add_mirrored: true
      # key positions as matrix positions and the corresponding costs
      # [from_position, to_position]: weight
      matrix_positions:
        # Finger repeats on same key
        [[2, 1], [2, 1]]: 0.5 # left pinky north
        [[1, 2], [1, 2]]: 0.5 # left pinky west
        [[2, 2], [2, 2]]: 0.3 # left pinky center
        [[3, 2], [3, 2]]: 0.5 # left pinky east
        [[2, 3], [2, 3]]: 0.5 # left pinky south
        # Right pinky positions
        [[23, 1], [23, 1]]: 0.5 # right pinky north
        [[22, 2], [22, 2]]: 0.5 # right pinky west
        [[23, 2], [23, 2]]: 0.3 # right pinky center
        [[24, 2], [24, 2]]: 0.5 # right pinky east
        [[23, 3], [23, 3]]: 0.5 # right pinky south

  # =============================================================================
  # Trigram metrics
  # =============================================================================

  trigram_stats:
    enabled: true
    weight: 0.0
    normalization:
      type: fixed
      value: 1.0
    params:
      ignore_modifiers: true
      ignore_thumbs: true

  sfs:
    enabled: true
    weight: 5.0
    normalization:
      type: weight_found
      value: 1.0
    params:
      ignore_thumb: true
      ignore_modifiers: true
      finger_factors:
        Pinky: 2.0
        Ring: 1.5
        Middle: 1.0
        Index: 0.75
        Thumb: 1.0

ngrams:
  # Increase the weight of bigrams that have both an absolute weight and relative weight exceed
  # specified thresholds.
  # NOTE: Currently disabled because weight_found normalization causes costs to decrease when
  # penalties are applied (opposite of intended behavior). The penalty system works but
  # optimization gets wrong signals due to normalization interaction.
  increase_common_ngrams:
    enabled: false
    # Bigrams with a relative weight exceeding this threshold are considered
    critical_fraction: 0.001
    # The weight for bigrams exceeding both thresholds is multiplied by this factor
    factor: 2.0
    # Bigrams with an absolute weight exceeding this threshold are considered
    total_weight_threshold: 20.0

ngram_mapper:
  # Exclude ngrams that contain a line break, followed by a non-line-break character.
  # This encodes a mental pause which usually comes after hitting the "Enter" key, before
  # continuing to write.
  exclude_line_breaks: true

  # Split symbols belonging to higher layers of the layout into combinations involving modifiers
  # required to activate the layer
  split_modifiers:
    enabled: true
    # Multiply the ngram's weight with this factor whenever the resulting ngram involves two
    # modifiers that are required for the same symbol
    same_key_mod_factor: 0.03125
